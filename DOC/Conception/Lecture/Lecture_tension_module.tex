
%===== Lecture de tension des modules =====

\section{Lecture de tension des modules}
			%\subsection{Objectifs}
				Nous désirons avoir une lecture très présise (+/- 2mV) de la tension du modules. Afin de pouvoir brancher les modules dans n'importe quel ordre sur le BMS, nous devons faire des lectures de tension isolées. Le circuit doit consommer un minimum de courant puisqu'il sera alimenté par le modules.
			\subsection{Circuit analogique}
				
				\begin{center}
					% Schema
					\includegraphics[scale=0.5]{Lecture/images/Analog} \\ \vspace{0cm}
				\end{center}
			
					%  BOM
					\begin{table}[h!]	
						\centering
						\begin{tabular}{|c|c|c|}
							\hline
							Part number & Description & Prix (total)\\ \hhline{|=|=|=|}
							BU7421SG-TR & Op-amp (2x) & 2\$ \\ \hline
							LOC110STR & Optocoupleur linéaire & 4.09\$ \\ \hline
							 \multicolumn{2}{|c|}{*Prix de digikey pour 1 unité }& 6.09\$ \\ \hline
						\end{tabular}
						\caption{Bill of material - Analog}
						%\label{table:BOM_Analog}
					\end{table}
						
					% Avantage // Desavantage	
					\begin{table}[h!]
					\centering
						\begin{tabular}{|c|c|}
							\hline
							Avantage & Désavantage\\ \hhline{|=|=|}
							Peu de composantes & Précision de +/- 1\% \\ \hline
							Robuste & L'optocoupleur linéaire est gros (SOIC 8)\\ \hline
							 & Consomme beaucoup de courant (10mA max)\\ \hline
						\end{tabular}
						\caption{Avantage et désavantage - Analog}
						%\label{table:Analyse_Analog}
					\end{table} 
					
				% Conclusion
				Le circuit analogique autour de l'optocoupleur linéaire n'est pas assez précis pour être considéré comme viable pour le projet.De plus, il consomme beaucoup trop de courant pour pouvoir être toujours en marche. Il faudrait ajouter un circuit pour désactiver la lecture lorsqu'elle n'est pas utilisé. Ceci enlève l'avantage d'utiliser cette solution. 
				\newpage
				
			\subsection{Circuit digital}
				\subsubsection{Protocole de communication}
					Les ADC externes utilisent souvent les même trois interface de communication sériel : UART,I2C et SPI. Puisque nous avons un nombre limité de ces periphérique sur le microcontrôleur, nous aurons besoin d'un bus qui permet d'avoir un maximum d'ADC. Il nous reste donc le choix entre le I2C et le SPI. Le SPI demanderais d'avoir un circuit d'isolation considérablement plus gros et dispendieux que le I2C. Le SPI à deux fils de plus que le I2C ( 1 pour le data et 1 pour choisir le "slave"). \\
					Le protocol choisis est le I2C et le circuit d'isolation est le ISO1541DR. Malheureusement, le circuit consomme un petit peu moins de 5mA. Nous devrons donc avoir une alimentation qui permettra de désactiver l'alimentation du côté du modules lorsque le système ne sera pas en marche.
					
				\subsubsection{Lecture d'un voltage de référence}
					La première solution envisagé étaient de lire un voltage de référence avec le ADC. Puisqu'on connait la tension à l'entrée, il est possible de déterminer la tension de l'alimentation du ADC avec la valeur de la lecture. Le ADS1013 avait été retenue puisqu'il a une alimentation de 2 à 5.5V, un quiescent current de 150$\mu$A et une résolution de 12 bits. Cependant, ce ADC a une entrée différentielle et nous aurions seulement utilisé la moitiée de la plage. Nous nous retrouverions ainsi avec uns résolution de 11 bits. En utilisant un voltage de référence de 2.048V, nous obtenerions une précision de 4.2mV lorsque le module est à 4.2V.Nous somme près de nos objectifs mais le voltage minimum pour l'alimentation de l'isolateur I2C (3V) fait en sorte que cette solution ne peut être envisagée.
					% Schema
					\begin{figure}[h]
						\centering
						\includegraphics[scale=0.3]{./Lecture/images/Voltage_reference} \\ \vspace{0cm}
						\caption{Schéma fonctionnel : Voltage de référence }
						%\label{fig:schema_voltage_ref}
					\end{figure}

				\newpage
				\subsubsection{Lecture de la tension du module}
					Pour pouvoir mesurer la tension du module, l'alimentation du ADC doit être au dessus du voltage maximal du module plus une marge de sécurité. De plus, il est plus intéressant d'utiliser un ADC "single ended" ou "pseudo differential" pour avoir accès à toute la plage. Il est donc nécessaire d'avoir un "boost" pour amener la tension d'alimentation à 5V. Cette tension va alimenter le circuit d'isolation I2C. Un régulateur linéaire sera nécessaire pour alimenter le ADC afin d'avoir un minimum de bruit dans les lecture. Un "boost" avec l'option "shutdown" sera utilisé pour que le circuit ne vide pas les batteries lorsque le "battery pack" est entreposé. Un premier ADC, le MCP3221A5T avait été selectionné mais il fut rejeté puisqu'il est impossible de changer l'adresse du IC (elle doit être changé par la compagnie). En ce moment, les pièces envisagées sont :
					
					%  BOM
					\begin{table}[H]
						\centering
						\renewcommand{\arraystretch}{1.3}
						\begin{tabular}{|c|c|c|}
							\hline
							Part number & Description & Prix (total) \\ \hhline {|=|=|=|}
							ADC121C021CIMM/NOPB & ADC 12 bit I2C & 4.3\$ \\ \hline
							AP2202K-ADJTRG1 & LDO & 0.63\$ \\ \hline
							AP3015KTR-G1 & Boost & 1.1\$ \\ \hline
							ISO1541DR & Isolation I2C & 6.67\$ \\
							   ou 	  & ou & ou \\
							SI8602AC-B-IS & Isolation I2C & 4.62 \$ \\ \hline
							LTV-816S & Optocoupleur (boost shutdown) & 0.61\$ \\ \hline
							\multicolumn{2}{|c|}{ }& 13.31 ou 11.31\$ \\ \hline
							\multicolumn{3}{r}{ } Prix de digikey pour 1 unité \\ 
						\end{tabular} \\ \vspace{0cm} 
						\caption{Bill of material - Digital}
						%\label{table:BOM_Digital}
					\end{table}
				% Schema
				\begin{figure}[h]
					\centering
					\includegraphics[scale=0.3]{./Lecture/images/Tension_module} \\ \vspace{0cm}
					\caption{Schéma fonctionnel : Lecture de la tension du module}
					%\label{fig:schema_tension_module}
				\end{figure}
			
				Un ADC secondaire (MCP3021) pourrait être connecté en parallèle avec le ADC primaire (ADC121C021CIMM/NOPB).
			
			Note : Mettre un mosfet comme protection de polarité inverse, voir pour mettre la gate sur la pin SHDN du boost pour éviter qu'il y ait un tension sur l'entrée de l'ADC lorsqu'il n'est pas alimenté.
